<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="cn.tdw.dao.DailyTaskInfoDAO">

    <sql id="DailyTaskInfoColumn">
		id,tracker_id,day_task_count,day_task_amount,day_repay_count,day_repay_count_percent,day_repay_amount,day_repay_amount_percent,add_date,
		remark,create_time,update_time,is_deleted
	</sql>

    <select id="queryAllocationDetailTotal" resultType="cn.tdw.dto.AllocationDetailTotalDTO">
		SELECT
		sum(d.day_task_count)day_task_count,
		sum(d.day_repay_count) day_repay_count,
		sum(d.day_repay_amount)day_repay_amount,
		sum(m.month_repay_count) month_repay_count,
		sum(m.month_repay_count_percent) month_repay_count_percent,
		sum(m.month_repay_amount_percent) month_repay_amount_percent,
		sum(m.month_repay_amount) month_repay_amount,
		sum(t.task_count-t.repay_count) task_count,
		sum(t.task_amount) task_amount
		FROM
        total_task_info t
        LEFT JOIN monthly_task_info m ON t.tracker_id = m.tracker_id
        AND m.add_date = #{monthDate}
        LEFT JOIN daily_task_info d ON d.tracker_id = t.tracker_id
        AND d.add_date = #{dayDate}
	</select>

    <select id="queryAllocationDetails" resultType="cn.tdw.dto.AllocationDetailDTO">
		SELECT
		    u.user_id trackerId,
			u.username,
			u.job_num,
			u.mobile,
			d.day_task_count,
			d.day_repay_count,
			d.day_repay_amount,
			m.month_repay_count,
			IFNULL(m.month_repay_count_percent,'0.00%') monthRepayCountPercent,
			IFNULL(m.month_repay_amount_percent,'0.00%') monthRepayAmountPercent ,
			m.month_repay_amount,
		    t.task_count-t.repay_count  task_count,
			t.task_amount
		FROM
        sys_user u
        LEFT JOIN daily_task_info d   on d.tracker_id=u.user_id AND d.add_date = #{dayDate}
        LEFT JOIN monthly_task_info m ON u.user_id = m.tracker_id
        AND m.add_date = #{monthDate}
        LEFT JOIN total_task_info t ON u.user_id = t.tracker_id
        where u.user_id !=1
		ORDER BY day_task_count DESC,trackerId
	</select>


    <select id="queryTrackerCount" resultType="int">
		SELECT count(1) FROM sys_user

		where  user_id != 1


	</select>

    <select id="queryTaskInfoByAddDate" resultType="cn.tdw.dto.TaskInfoDTO">

        SELECT
       	id,
       	tracker_id,
       	day_task_count AS taskCount,
       	day_task_amount AS taskAmount,
       	day_repay_count AS repayCount,
       	day_repay_count_percent AS repayCountPercent,
       	day_repay_amount AS repayAmount ,
       	day_repay_amount_percent AS repayAmountPercent,
       	add_date,
		remark,
		create_time,
		update_time,
		is_deleted
        from daily_task_info where add_date=#{addDate}
    </select>

    <insert id="batchInsertTaskInfo">
        INSERT INTO daily_task_info(
        tracker_id,
        day_task_count,
        day_task_amount,
        day_repay_count,
        day_repay_count_percent,
        day_repay_amount,
        day_repay_amount_percent,
        add_date

        )VALUES
        <foreach collection="list" item="item" separator=",">
            (#{item.trackerId},
            #{item.taskCount},
            #{item.taskAmount},
            #{item.repayCount},
            #{item.repayCountPercent},
            #{item.repayAmount},
            #{item.repayAmountPercent},
            #{item.addDate})
        </foreach>

    </insert>

    <update id="batchUpdateTaskInfo">
        <foreach collection="list" item="item" separator=";">
            UPDATE daily_task_info SET

            day_task_count=#{item.taskCount},
            day_task_amount=#{item.taskAmount},
            day_repay_count=#{item.repayCount},
            day_repay_count_percent=#{item.repayCountPercent},
            day_repay_amount=#{item.repayAmount},
            day_repay_amount_percent=#{item.repayAmountPercent}
            <where>
                AND add_date=#{item.addDate}
                AND tracker_id =#{item.trackerId}
            </where>
        </foreach>

    </update>

</mapper>