<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="cn.tdw.dao.PostLoanDAO">

	<resultMap id="BaseResultMap" type="cn.tdw.dto.PostLoanDTO">
		<id column="borrowId" jdbcType="CHAR" property="borrowId" />
		<result column="status" jdbcType="INTEGER" property="status" />
		<result column="amount" jdbcType="INTEGER" property="amount" />
		<result column="realAmount" jdbcType="INTEGER" property="realAmount" />
		<result column="channelId" jdbcType="INTEGER" property="channelId" />
		<result column="channelName" jdbcType="VARCHAR" property="channelName" />
		<result column="userId" jdbcType="CHAR" property="userId" />
		<result column="realName" jdbcType="VARCHAR" property="realName" />
		<result column="cost" jdbcType="INTEGER" property="cost" />
		<result column="penaltyAmount" jdbcType="INTEGER" property="penaltyAmount" />
		<result column="trackerName" jdbcType="VARCHAR" property="trackerName" />
		<result column="tracker_id" jdbcType="INTEGER" property="trackerId" />
		<result column="overDueId" jdbcType="INTEGER" property="overDueId" />
		<result column="cycDate" jdbcType="TIMESTAMP" property="cycDate" />
		<result column="telNo" jdbcType="VARCHAR" property="telNo" />
	</resultMap>

	<select id="list" resultMap="BaseResultMap" parameterType="cn.tdw.dto.PostLoanSearchDTO">
		SELECT b.borrowId, b.status,
		b.amount, b.realAmount, b.cycDate,
		b.userId, u.realName, u.telNo, r.channelId, c.tracker_id
		FROM BorrowInfo b
		LEFT JOIN UserBasicInfo u ON b.userId = u.userId
		LEFT JOIN UserChannelRegister r ON b.userId = r.userId
		LEFT JOIN collection_task c ON c.borrow_id = b.borrowId
		WHERE
		1 = 1
		<if test="realName != null and realName != ''">
			AND u.realName = #{realName}
		</if>
		<if test="telNo != null and telNo != ''">
			AND u.telNo = #{telNo}
		</if>
		<if test="cycDateBegin != null and cycDateBegin != ''">
			AND b.cycDate >= #{cycDateBegin}
		</if>
		<if test="cycDateEnd != null and cycDateEnd != ''">
			<![CDATA[
				AND b.cycDate <= #{cycDateEnd}
			]]>
		</if>
		<if test="status != null">
			AND b.status = #{status}
		</if>
		<if test="borrowId != null and borrowId != ''">
			AND b.borrowId = #{borrowId}
		</if>
		<if test="channelId != null">
			AND r.channelId = #{channelId}
		</if>
		<choose>
			<when test="overDueDaysBegin != null and overDueDaysEnd != null">
				AND status IN (7, 8) AND datediff(#{today}, b.cycDate) BETWEEN #{overDueDaysBegin} AND #{overDueDaysEnd}
			</when>

			<when test="overDueDaysBegin != null">
				AND status IN (7, 8) AND datediff(#{today}, b.cycDate) >= #{overDueDaysBegin}
			</when>
			<when test="overDueDaysEnd != null">
				<![CDATA[AND status IN (7, 8) AND datediff(#{today}, b.cycDate) <= #{overDueDaysEnd}]]>
			</when>
			<otherwise></otherwise>
		</choose>
		<if test="trackerId != null">
			AND c.tracker_id = #{trackerId}
		</if>
		ORDER BY b.cycDate DESC
	</select>

</mapper>